name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
  VPS_DEPLOY_PATH: /opt/coingecko-ingest

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VPS_SSH_KEY }}
        known_hosts: 'just-a-placeholder'
        
    - name: Setup VPS
      run: |
        ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
          sudo mkdir -p $VPS_DEPLOY_PATH/data/{raw,delta,processed}
          sudo chown -R $VPS_USER:$VPS_USER $VPS_DEPLOY_PATH
          sudo chmod -R 755 $VPS_DEPLOY_PATH
          
          # Install Docker if not exists
          if ! command -v docker &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y docker.io docker-compose
            sudo usermod -aG docker $USER
            sudo systemctl enable --now docker
          fi
        "
        
    - name: Deploy application
      run: |
        # Copy files to VPS
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.idea' \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          . $VPS_USER@$VPS_HOST:$VPS_DEPLOY_PATH/
          
        # Start/restart services
        ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
          cd $VPS_DEPLOY_PATH
          docker-compose down
          docker-compose pull
          docker-compose up -d --build
        "
        
    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
          cd $VPS_DEPLOY_PATH
          docker ps
          echo '\nContainers status:'
          docker-compose ps
        "
